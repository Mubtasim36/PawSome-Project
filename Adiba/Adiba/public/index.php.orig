<?php
declare(strict_types=1);

session_start();

define('BASE_PATH', dirname(__DIR__));
define('APP_PATH', BASE_PATH . '/app');

require_once APP_PATH . '/core/helpers.php';

// -------------------------
// Router
// -------------------------
// WEB: /<role>/<page>
// API: /api/<role>/<action>

$url = $_GET['url'] ?? '';
$url = trim((string)$url, "/ \t\n\r\0\x0B");

// Default route
if ($url === '') {
    if (is_logged_in()) {
        $role = (string)($_SESSION['user']['role'] ?? '');
        if ($role === 'adopter') {
            redirect('adopter/dashboard');
        }
        // fall back to login
        redirect('auth/login');
    }
    redirect('auth/login');
}

$parts = explode('/', $url);
$first  = $parts[0] ?? '';
$second = $parts[1] ?? '';
$third  = $parts[2] ?? '';

try {
    // -------------------------
    // API routes
    // -------------------------
    if ($first === 'api') {
        $role = $second;
        $action = $third;

        if ($role === '' || $action === '') {
            json_response(['success' => false, 'message' => 'Invalid API route'], 404);
        }

        $controllerClass = ucfirst($role) . 'ApiController';
        $controllerFile = APP_PATH . "/controllers/api/$role/{$controllerClass}.php";

        if (!file_exists($controllerFile)) {
            json_response(['success' => false, 'message' => 'API controller not found'], 404);
        }

        require_once $controllerFile;
        if (!class_exists($controllerClass)) {
            json_response(['success' => false, 'message' => 'API controller class missing'], 500);
        }

        $controller = new $controllerClass();
        if (!method_exists($controller, $action)) {
            json_response(['success' => false, 'message' => 'API action not found'], 404);
        }

        $controller->$action();
        exit;
    }

    // -------------------------
    // Web routes
    // -------------------------
    $role = $first;
    $page = $second !== '' ? $second : 'login';

    $controllerClass = ucfirst($page) . 'Controller';
    $controllerFile = APP_PATH . "/controllers/$role/{$controllerClass}.php";

    if (!file_exists($controllerFile)) {
        http_response_code(404);
        echo 'Controller not found';
        exit;
    }

    require_once $controllerFile;
    if (!class_exists($controllerClass)) {
        http_response_code(500);
        echo 'Controller class missing';
        exit;
    }

    $controller = new $controllerClass();
    if (!method_exists($controller, 'index')) {
        http_response_code(500);
        echo 'index() missing in controller';
        exit;
    }

    $controller->index();
} catch (Throwable $e) {
    http_response_code(500);
    echo 'Server error: ' . e($e->getMessage());
}
